version: 1.0.{build}

branches:
  only:
    - develop

image: Visual Studio 2017

shallow_clone: true
clone_depth: 1

skip_tags: true

configuration:
  - Release-Far3

platform:
  - Win32
  - x64

build:
  project: src\Observer.sln
  verbosity: minimal

test: off

matrix:
  fast_finish: true

install:
  - SET PATH=%PATH%;C:\msys64\usr\bin
  - cd src\extra
  - m4 -P version.m4 > version.txt
  - SET /p PVER=<version.txt
  - appveyor UpdateBuild -Version %PVER%.%APPVEYOR_BUILD_NUMBER%
  - DEL version.txt
  - IF "%platform%" == "Win32" (SET P_ARCH=x86) ELSE (SET P_ARCH=%platform%)
  - cd C:\Tools\vcpkg
  - git pull --prune --quiet
  - .\bootstrap-vcpkg.bat -disableMetrics
  - vcpkg integrate install
  - vcpkg install zlib:%P_ARCH%-windows
  - vcpkg install bzip2:%P_ARCH%-windows
  - vcpkg install glib:%P_ARCH%-windows
  - vcpkg install boost-iostreams:%P_ARCH%-windows
  - cd %APPVEYOR_BUILD_FOLDER%

cache:
  - c:\tools\vcpkg\installed\ -> appveyor.yml

after_build:
- cmd: >-
    cd %APPVEYOR_BUILD_FOLDER%

    xcopy bin\%configuration%-%platform%\* export\Observer /E /I /Y >nul

    cd export\Observer\modules

    7z a -bd -- Observer_Refaim_RenPy_%configuration:~-4%_%P_ARCH%.7z renpy.so python37.dll zlib1.dll

    xcopy *.7z %APPVEYOR_BUILD_FOLDER% /Y >nul

    del /Q *.7z

    cd %APPVEYOR_BUILD_FOLDER%

    7z a -r -sdel -bd -x!*.ipdb -x!*.iobj -x!*.metagen -- Observer_Refaim_%configuration:~-4%_%P_ARCH%.7z .\export\*

artifacts:
  - path: '*.7z'

deploy:
  - provider: BinTray
    username: refaim
    api_key:
      secure: pKZQ3ll3GRbdHxfi43xCiI2jcAII11t/N7/BDuo2OC/vDjLmER21SmEeu9s6Peu3
    subject: refaim
    repo: Observer
    package: Observer
    version: $(PVER)
    publish: true
    override: true
    explode: false
